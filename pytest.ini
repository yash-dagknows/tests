[pytest]
# Pytest configuration for DagKnows test suite

# Test discovery patterns
python_files = test_*.py
python_classes = Test*
python_functions = test_*

# Minimum Python version
minversion = 7.0

# Test paths
testpaths = 
    unit
    integration
    e2e

# Add current directory to Python path
pythonpath = . .. ../taskservice/src ../req_router/src

# Console output format
console_output_style = progress
addopts = 
    # Verbose output
    -v
    # Show local variables in tracebacks
    --showlocals
    # Show summary of all test outcomes
    -ra
    # Strict markers (fail on unknown markers)
    --strict-markers
    # Show warnings
    -W default
    # Enable color output
    --color=yes
    # Show test durations (slowest 10)
    --durations=10
    # Fail on first error (comment out for full runs)
    # -x
    # Coverage options (uncomment for coverage runs)
    # --cov=../taskservice/src
    # --cov=../req_router/src
    # --cov-report=html
    # --cov-report=term-missing
    # --cov-fail-under=70

# Markers for test categorization
markers =
    unit: Unit tests (fast, isolated, no external dependencies)
    integration: Integration tests (multiple services, real dependencies)
    e2e: End-to-end tests (complete workflows, slow)
    slow: Tests that take more than 5 seconds
    smoke: Critical smoke tests for quick validation
    tenant: Tests related to tenant management
    task: Tests related to task operations
    auth: Tests related to authentication/authorization
    permissions: Tests related to permission system
    workspace: Tests related to workspace operations
    ai: Tests related to AI session functionality
    api: API endpoint tests
    database: Tests requiring database
    elasticsearch: Tests requiring Elasticsearch
    postgres: Tests requiring PostgreSQL
    grpc: Tests for gRPC endpoints
    rest: Tests for REST endpoints
    multiservice: Tests spanning multiple services
    performance: Performance and load tests
    security: Security-related tests
    skip_ci: Skip in CI environment
    wip: Work in progress (skip by default)

# Logging
log_cli = false
log_cli_level = INFO
log_cli_format = %(asctime)s [%(levelname)8s] [%(filename)s:%(lineno)s] %(message)s
log_cli_date_format = %Y-%m-%d %H:%M:%S

log_file = logs/pytest.log
log_file_level = DEBUG
log_file_format = %(asctime)s [%(levelname)8s] [%(filename)s:%(lineno)s] %(message)s
log_file_date_format = %Y-%m-%d %H:%M:%S

# Warnings
filterwarnings =
    error
    ignore::UserWarning
    ignore::DeprecationWarning
    # Ignore specific warnings from third-party libraries
    ignore:.*elasticsearch.*:DeprecationWarning
    ignore:.*urllib3.*:DeprecationWarning

# Timeout for tests (prevent hanging tests)
timeout = 300
timeout_method = thread

# Disable cacheprovider if it causes issues
# cache_dir = .pytest_cache

# Coverage options
[coverage:run]
source = 
    ../taskservice/src
    ../req_router/src
omit = 
    */tests/*
    */test_*.py
    */__pycache__/*
    */site-packages/*
    */venv/*
    */migrations/*
    */protos/*
    */gen/*

[coverage:report]
precision = 2
show_missing = True
skip_covered = False
exclude_lines =
    pragma: no cover
    def __repr__
    raise AssertionError
    raise NotImplementedError
    if __name__ == .__main__.:
    if TYPE_CHECKING:
    @abstract

[coverage:html]
directory = htmlcov

